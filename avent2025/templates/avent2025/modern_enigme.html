{% extends "avent2025/modern_base.html" %}
{% load static %}
{% load customfilters2025 %}

{% block title %}√ânigme {{ enigme.id }} - Calendrier de l'Avent 2025{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'avent2025/css/modern-enigme.css' %}">
{% endblock %}

{% block content %}

<div class="enigme-container fade-in">
    <!-- Message d'avertissement pour super admin -->
    {% if date_warning %}
    <div class="admin-warning">
        {{ date_warning }}
    </div>
    {% endif %}

    {% if user_reponse == 'OK' %}
    <!-- Page de victoire -->
    <div class="enigme-header">
        <div class="enigme-number">‚úÖ √ânigme #{{ old_enigme_id }} valid√©e !</div>
        <h1>F√©licitations !</h1>
    </div>
    
    <div class="enigme-card">
        <div class="enigme-content" style="text-align: center;">
            <div class="enigme-feedback success" style="margin: 2rem 0; font-size: 1.2rem;">
                <p>üéâ Bien jou√© ! Vous avez r√©solu l'√©nigme #{{ old_enigme_id }} !</p>
            </div>
            {% if image_reponse %}
            <div style="margin: 2rem 0;">
                <img src="{% static 'avent2025/images/gagne/' %}{{ image_reponse }}" alt="Victoire !" style="max-width: 60%; height: auto; border-radius: var(--border-radius);">
            </div>
            {% endif %}
            <a href="{% url 'avent2025:display_enigme' %}" class="enigme-submit-btn" style="display: inline-block; margin-top: 2rem;">
                ‚ñ∂Ô∏è Passer √† l'√©nigme #{{ enigme.id }}
            </a>
        </div>
    </div>
    
    {% elif user_reponse == 'KO' %}
    <!-- Page d'erreur -->
    <div class="enigme-header">
        <div class="enigme-number">‚ùå Mauvaise r√©ponse</div>
        <h1>{{ enigme.titre }}</h1>
    </div>
    
    <div class="enigme-card">
        <div class="enigme-content" style="text-align: center;">
            <div class="enigme-feedback error" style="margin: 2rem 0; font-size: 1.2rem;">
                <p>üòï Ce n'est pas la bonne r√©ponse. R√©essayez !</p>
            </div>
            {% if image_reponse %}
            <div style="margin: 2rem 0;">
                <img src="{% static 'avent2025/images/perdu/' %}{{ image_reponse }}" alt="Erreur" style="max-width: 60%; height: auto; border-radius: var(--border-radius);">
            </div>
            {% endif %}
            <a href="{% url 'avent2025:display_enigme' %}" class="enigme-submit-btn" style="display: inline-block; margin-top: 2rem;">
                üîÑ R√©essayer
            </a>
        </div>
    </div>
    
    {% else %}
    <!-- Affichage normal de l'√©nigme -->
    <!-- En-t√™te de l'√©nigme -->
    <div class="enigme-header">
        <div class="enigme-number">√ânigme #{{ enigme.id }}</div>
        <h1>{{ enigme.titre }}</h1>
    </div>

    <!-- Carte principale de l'√©nigme -->
    <div class="enigme-card">
        <div class="enigme-content">
            <!-- Texte de l'√©nigme -->
            <div class="enigme-text">
                {{ enigme.texte|safe }}
            </div>

            <!-- Image de l'√©nigme si disponible -->
            {% if enigme.image_name %}
            <div class="enigme-image-container">
                <a href="{{ enigme.image_name.url }}" class="image-lightbox" data-lightbox="enigme-image">
                    <img src="{{ enigme.image_name.url }}" alt="Image de l'√©nigme" class="enigme-image">
                    <div class="image-zoom-hint">
                        <span>üîç Cliquer pour agrandir</span>
                    </div>
                </a>
            </div>
            {% endif %}

            <!-- Formulaire de r√©ponse ou r√©ponse valid√©e -->
            <div class="enigme-form">
                {% if is_resolved %}
                    <!-- √ânigme d√©j√† r√©solue : afficher la r√©ponse masqu√©e -->
                    <div class="resolved-answer-container">
                        <label>‚úÖ √ânigme r√©solue ! Votre r√©ponse valid√©e :</label>
                        <div class="resolved-answer-wrapper">
                            <input 
                                type="password" 
                                id="resolved_answer_{{ enigme.id }}" 
                                value="{{ reponse_enigme }}" 
                                class="enigme-input resolved-answer" 
                                readonly
                            >
                            <button 
                                type="button" 
                                class="toggle-answer-btn" 
                                onclick="toggleAnswer('resolved_answer_{{ enigme.id }}', this)"
                                title="Afficher/Masquer la r√©ponse"
                            >
                                üëÅÔ∏è
                            </button>
                        </div>
                        <p class="resolved-hint">üí° Cliquez sur l'≈ìil pour r√©v√©ler la r√©ponse</p>
                    </div>
                {% else %}
                    <!-- √ânigme en cours : formulaire de r√©ponse -->
                    <form method="post" action="{% url 'avent2025:validate_enigme' %}">
                        {% csrf_token %}
                        <label for="user_reponse">üí≠ Votre r√©ponse :</label>
                        <div class="enigme-input-group">
                            <input 
                                type="text" 
                                id="user_reponse" 
                                name="user_reponse" 
                                class="enigme-input" 
                                placeholder="Entrez votre r√©ponse..."
                                autocomplete="off"
                                required
                            >
                            <button type="submit" class="enigme-submit">
                                ‚úì Valider
                            </button>
                        </div>
                    </form>
                {% endif %}

                <!-- Feedback de la r√©ponse pr√©c√©dente -->
                {% if user_reponse %}
                    {% if user_reponse|lower == enigme.reponse|lower %}
                    <div class="enigme-feedback success">
                        <span>‚úÖ</span>
                        <span>Bravo ! Vous avez trouv√© la bonne r√©ponse !</span>
                    </div>
                    {% else %}
                    <div class="enigme-feedback error">
                        <span>‚ùå</span>
                        <span>Ce n'est pas la bonne r√©ponse. R√©essayez !</span>
                    </div>
                    {% endif %}
                {% endif %}
            </div>

            <!-- Section des indices -->
            {% if indices %}
            <div class="indices-section" id="indices">
                <div class="indices-header">
                    <h3>üí° Indices disponibles</h3>
                    <span class="indices-count">{{ indices|length }} indice{{ indices|length|pluralize }}</span>
                </div>

                {% for indice in indices %}
                <div class="indice-card{% if indice.type_indice == 'LC' %} last-chance{% endif %}">
                    <div class="indice-header">
                        <div class="indice-title-section">
                            <span class="indice-number">Indice #{{ indice.numero }}</span>
                            <span class="indice-badges">
                                {% if indice.type_indice == 'LC' %}
                                <span class="indice-last-chance-badge" title="Derni√®re chance - Co√ªt plus √©lev√©">
                                    ‚ö†Ô∏è DERNI√àRE CHANCE
                                </span>
                                {% endif %}
                                <span class="indice-cost-badge{% if indice.type_indice == 'LC' %} cost-high{% endif %}" title="Co√ªt en points">
                                    üí∞ {{ indice.cout }} pt{{ indice.cout|pluralize }}
                                </span>
                                {% if indice.categorie == 'ME' %}
                                <span class="indice-category-badge category-mecanique" title="M√©canique">
                                    üîß M√©canique
                                </span>
                                {% elif indice.categorie == 'RE' %}
                                <span class="indice-category-badge category-reponse" title="R√©ponse attendue">
                                    üí° R√©ponse
                                </span>
                                {% endif %}
                            </span>
                        </div>
                        {% if indice not in indices_reveles %}
                        <form method="post" action="{% url 'avent2025:reveler_indice' %}" style="margin: 0;">
                            {% csrf_token %}
                            <input type="hidden" name="indice_id" value="{{ indice.id }}">
                            <button type="submit" class="indice-reveal-btn">
                                üîì R√©v√©ler (-{{ indice.cout }} pt{{ indice.cout|pluralize }})
                            </button>
                        </form>
                        {% endif %}
                    </div>
                    
                    {% if indice in indices_reveles %}
                    <div class="indice-content">
                        {% if indice.texte %}
                            <p>{{ indice.texte|safe }}</p>
                        {% endif %}
                        {% if indice.image %}
                            <div class="enigme-image-container">
                                <a href="{{ indice.image.url }}" class="image-lightbox" data-lightbox="indice-image">
                                    <img src="{{ indice.image.url }}" alt="Image de l'indice" class="indice-image">
                                    <div class="image-zoom-hint">
                                        <span>üîç Cliquer pour agrandir</span>
                                    </div>
                                </a>
                            </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="indice-hidden">
                        üîí Cet indice est verrouill√©. Cliquez sur "R√©v√©ler l'indice" pour le d√©bloquer.
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Progression et stats -->
        <div class="enigme-progress">
            <div class="progress-info">
                <div class="progress-item">
                    <span class="progress-label">Votre score</span>
                    <span class="progress-value">{{ user.userprofile_2025.score }}</span>
                </div>
                <div class="progress-item">
                    <span class="progress-label">Erreurs</span>
                    <span class="progress-value">{{ user.userprofile_2025.erreurEnigma }}</span>
                </div>
                <div class="progress-item">
                    <span class="progress-label">Indices r√©v√©l√©s</span>
                    <span class="progress-value">{{ indices_reveles|length }}</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Navigation -->
    <div class="enigme-navigation">
        <a href="{% url 'avent2025:home' %}" class="nav-btn nav-btn-previous">
            ‚Üê Retour √† l'accueil
        </a>
        <a href="{% url 'avent2025:classement' %}" class="nav-btn nav-btn-next">
            Voir le classement ‚Üí
        </a>
    </div>
</div>

<script>
// Fonction pour afficher/masquer la r√©ponse
function toggleAnswer(inputId, button) {
    const input = document.getElementById(inputId);
    if (input.type === 'password') {
        input.type = 'text';
        button.textContent = 'üôà';
        button.title = 'Masquer la r√©ponse';
    } else {
        input.type = 'password';
        button.textContent = 'üëÅÔ∏è';
        button.title = 'Afficher la r√©ponse';
    }
}
</script>

{% endblock %}
