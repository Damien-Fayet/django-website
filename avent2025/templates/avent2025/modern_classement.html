{% extends "avent2025/modern_base.html" %}
{% load static %}
{% load customfilters2025 %}

{% block title %}Classement - Calendrier de l'Avent 2025{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'avent2025/css/modern-classement.css' %}">
{% endblock %}

{% block content %}

<div class="classement-container fade-in">
    <!-- En-tÃªte -->
    <div class="classement-header">
        <h1>ğŸ† Classement {% if score_type == 'enigmes' %}Ã‰nigmes{% elif score_type == 'devinettes' %}Devinettes{% else %}GÃ©nÃ©ral{% endif %} 2025</h1>
        <p>
            {% if score_type == 'enigmes' %}
                Classement basÃ© uniquement sur les Ã©nigmes principales
            {% elif score_type == 'devinettes' %}
                Classement basÃ© uniquement sur les devinettes quotidiennes
            {% else %}
                DÃ©couvrez qui mÃ¨ne la course dans le calendrier de l'Avent !
            {% endif %}
        </p>
    </div>

    <!-- Filtres -->
    <div class="leaderboard-filters">
        <a href="?filter=all&type={{ score_type }}" class="filter-btn {% if filter_type == 'all' %}active{% endif %}">
            ğŸ‘¥ Tous ({{ total_users }})
        </a>
        <a href="?filter=family&type={{ score_type }}" class="filter-btn {% if filter_type == 'family' %}active{% endif %}">
            ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Famille ({{ family_count }})
        </a>
        <a href="?filter=public&type={{ score_type }}" class="filter-btn {% if filter_type == 'public' %}active{% endif %}">
            ğŸŒ Public ({{ public_count }})
        </a>
    </div>

    <!-- Filtres de type de classement -->
    <div class="leaderboard-filters">
        <a href="?filter={{ filter_type }}&type=general" class="filter-btn {% if score_type == 'general' %}active{% endif %}">
            ğŸ† Classement GÃ©nÃ©ral
        </a>
        <a href="?filter={{ filter_type }}&type=enigmes" class="filter-btn {% if score_type == 'enigmes' %}active{% endif %}">
            ğŸ§© Classement Ã‰nigmes
        </a>
        <a href="?filter={{ filter_type }}&type=devinettes" class="filter-btn {% if score_type == 'devinettes' %}active{% endif %}">
            ğŸ­ Classement Devinettes
        </a>
    </div>

    <!-- Statistiques globales -->
    <div class="stats-overview-compact">
        <div class="stat-compact">
            ğŸ‘¥ <strong>{{ users|length }}</strong> participants
        </div>
        <div class="stat-compact">
            ğŸ“Š Score moyen : <strong>{{ avg_score|floatformat:0 }}</strong>
        </div>
    </div>

    <!-- Podium (Top 3) -->
    {% if users|length >= 3 %}
    <div class="podium-section">
        {% for user in users|slice:":3" %}
        <div class="podium-card rank-{{ forloop.counter }}">
            <div class="podium-medal">
                {% if forloop.counter == 1 %}ğŸ¥‡
                {% elif forloop.counter == 2 %}ğŸ¥ˆ
                {% else %}ğŸ¥‰{% endif %}
            </div>
            <div class="podium-username">{{ user.username }}</div>
            <div class="podium-score-main">
                {% if score_type == 'enigmes' %}
                    {{ enigme_score|get_item:user.id }}
                {% elif score_type == 'devinettes' %}
                    {{ devinette_score|get_item:user.id }}
                {% else %}
                    {{ scores|get_item:user.id }}
                {% endif %}
            </div>
            <div class="podium-stats-compact">
                ğŸ§© {{ nb_enigmes|get_item:user.id }}/8 â€¢ ğŸ­ {{ nb_devinettes|get_item:user.id }}/24
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Table complÃ¨te du classement -->
    <div class="classement-table-container">
        <h2 class="table-title">ğŸ“‹ Classement complet</h2>
        <table class="classement-table">
            <thead>
                <tr>
                    <th>Rang</th>
                    <th>Participant</th>
                    <th>ğŸ’¯ Score</th>
                    {% if score_type == 'general' %}
                    <th>ğŸ§© Ã‰nigmes</th>
                    <th>ğŸ­ Devinettes</th>
                    <th>âŒ Erreurs ğŸ§©</th>
                    <th>ğŸ’¡ Indices ğŸ§©</th>
                    <th>âŒ Erreurs ğŸ­</th>
                    <th>ğŸ’¡ Indices ğŸ­</th>
                    {% elif score_type == 'enigmes' %}
                    <th>ğŸ§© Ã‰nigmes</th>
                    <th>âŒ Erreurs</th>
                    <th>ğŸ’¡ Indices</th>
                    {% elif score_type == 'devinettes' %}
                    <th>ğŸ­ Devinettes</th>
                    <th>âŒ Erreurs</th>
                    <th>ğŸ’¡ Indices</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr {% if user == request.user %}class="current-user"{% endif %}>
                    <td class="rank-cell">
                        <span class="rank-badge {% if forloop.counter <= 3 %}top-3{% endif %}">
                            {% if forloop.counter == 1 %}ğŸ¥‡
                            {% elif forloop.counter == 2 %}ğŸ¥ˆ
                            {% elif forloop.counter == 3 %}ğŸ¥‰
                            {% else %}{{ forloop.counter }}{% endif %}
                        </span>
                    </td>
                    <td class="username-cell">
                        <strong>{{ user.username }}</strong>
                        {% if user == request.user %}<span class="badge-you">Vous</span>{% endif %}
                    </td>
                    <td class="score-cell">
                        <strong>
                            {% if score_type == 'enigmes' %}
                                {{ enigme_score|get_item:user.id }}
                            {% elif score_type == 'devinettes' %}
                                {{ devinette_score|get_item:user.id }}
                            {% else %}
                                {{ scores|get_item:user.id }}
                            {% endif %}
                        </strong>
                    </td>
                    {% if score_type == 'general' %}
                    <td class="enigmes-cell">{{ nb_enigmes|get_item:user.id }}/8</td>
                    <td class="devinettes-cell">{{ nb_devinettes|get_item:user.id }}/24</td>
                    <td class="erreurs-cell">
                        {{ nb_erreurs_enigmes|get_item:user.id }}
                        {% if malus_pts_erreurs_enigmes|get_item:user.id > 0 %}
                            <span style="color: #ff6b6b; font-size: 0.85em;">(-{{ malus_pts_erreurs_enigmes|get_item:user.id }} pts)</span>
                        {% endif %}
                    </td>
                    <td class="indices-cell">
                        {{ nb_indice_enigme|get_item:user.id }}
                        {% if cout_pts_indices_enigmes|get_item:user.id > 0 %}
                            <span style="color: #ffa94d; font-size: 0.85em;">(-{{ cout_pts_indices_enigmes|get_item:user.id }} pts)</span>
                        {% endif %}
                    </td>
                    <td class="erreurs-cell">
                        {{ nb_erreurs_devinettes|get_item:user.id }}
                        {% if malus_pts_erreurs_devinettes|get_item:user.id > 0 %}
                            <span style="color: #ff6b6b; font-size: 0.85em;">(-{{ malus_pts_erreurs_devinettes|get_item:user.id }} pts)</span>
                        {% endif %}
                    </td>
                    <td class="indices-cell">
                        {{ nb_indice_devinette|get_item:user.id }}
                        {% if cout_pts_indices_devinettes|get_item:user.id > 0 %}
                            <span style="color: #ffa94d; font-size: 0.85em;">(-{{ cout_pts_indices_devinettes|get_item:user.id }} pts)</span>
                        {% endif %}
                    </td>
                    {% elif score_type == 'enigmes' %}
                    <td class="enigmes-cell">{{ nb_enigmes|get_item:user.id }}/8</td>
                    <td class="erreurs-cell">
                        {{ nb_erreurs_enigmes|get_item:user.id }}
                        {% if malus_pts_erreurs_enigmes|get_item:user.id > 0 %}
                            <span style="color: #ff6b6b; font-size: 0.85em;">(-{{ malus_pts_erreurs_enigmes|get_item:user.id }} pts)</span>
                        {% endif %}
                    </td>
                    <td class="indices-cell">
                        {{ nb_indice_enigme|get_item:user.id }}
                        {% if cout_pts_indices_enigmes|get_item:user.id > 0 %}
                            <span style="color: #ffa94d; font-size: 0.85em;">(-{{ cout_pts_indices_enigmes|get_item:user.id }} pts)</span>
                        {% endif %}
                    </td>
                    {% elif score_type == 'devinettes' %}
                    <td class="devinettes-cell">{{ nb_devinettes|get_item:user.id }}/24</td>
                    <td class="erreurs-cell">
                        {{ nb_erreurs_devinettes|get_item:user.id }}
                        {% if malus_pts_erreurs_devinettes|get_item:user.id > 0 %}
                            <span style="color: #ff6b6b; font-size: 0.85em;">(-{{ malus_pts_erreurs_devinettes|get_item:user.id }} pts)</span>
                        {% endif %}
                    </td>
                    <td class="indices-cell">
                        {{ nb_indice_devinette|get_item:user.id }}
                        {% if cout_pts_indices_devinettes|get_item:user.id > 0 %}
                            <span style="color: #ffa94d; font-size: 0.85em;">(-{{ cout_pts_indices_devinettes|get_item:user.id }} pts)</span>
                        {% endif %}
                    </td>
                    {% endif %}
                </tr>
                {% empty %}
                <tr>
                    <td colspan="{% if score_type == 'general' %}9{% else %}6{% endif %}" class="empty-state">
                        <div class="empty-icon">ğŸ„</div>
                        <div>Aucun participant pour le moment.</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">Soyez le premier Ã  commencer l'aventure !</div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Retour Ã  l'accueil -->
    <div class="actions-footer">
        <a href="{% url 'avent2025:home' %}" class="btn btn-secondary">
            â† Retour Ã  l'accueil
        </a>
        <a href="{% url 'avent2025:display_enigme' %}" class="btn btn-primary">
            Continuer l'aventure â†’
        </a>
    </div>
</div>

{% endblock %}
