{% extends "avent2025/modern_base.html" %}
{% load static %}

{% block title %}Devinette {{ devinette.id }} - Calendrier de l'Avent 2025{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'avent2025/css/modern-enigme.css' %}">
{% endblock %}

{% block content %}

<div class="enigme-container fade-in">
    <!-- Message d'avertissement pour super admin -->
    {% if date_warning %}
    <div class="admin-warning">
        {{ date_warning }}
    </div>
    {% endif %}

    <!-- En-tÃªte de la devinette -->
    <div class="enigme-header devinette-header">
        <div class="enigme-number devinette-number">Devinette #{{ devinette.id }}</div>
        <h1>{{ devinette.titre }}</h1>
    </div>

    <!-- Messages de validation -->
    {% if user_reponse == 'OK' %}
    <div class="success-container">
        <div class="success-card">
            <div class="success-icon">ğŸ‰</div>
            <h2>Devinette {{ old_devinette_id }} validÃ©e !</h2>
            <p>Bien jouÃ© ! Vous avez trouvÃ© la bonne rÃ©ponse !</p>
            {% if image_reponse %}
            <div class="success-image">
                <img src="/static/avent2025/images/gagne/{{ image_reponse }}" alt="SuccÃ¨s">
            </div>
            {% endif %}
            <a href="{% url 'avent2025:display_devinette' %}" class="enigme-submit success-btn">
                â¡ï¸ Passer Ã  la devinette {{ devinette.id }}
            </a>
        </div>
    </div>
    {% elif user_reponse == 'KO' %}
    <div class="error-container">
        <div class="error-card">
            <div class="error-icon">ğŸ˜•</div>
            <h2>RatÃ© !</h2>
            <p>Ce n'est pas la bonne rÃ©ponse, mais ne vous dÃ©couragez pas !</p>
            {% if image_reponse %}
            <div class="error-image">
                <img src="/static/avent2025/images/perdu/{{ image_reponse }}" alt="Erreur">
            </div>
            {% endif %}
            <a href="{% url 'avent2025:display_devinette' %}" class="enigme-submit retry-btn">
                ğŸ”„ RÃ©essayer
            </a>
        </div>
    </div>
    {% else %}

    <!-- Carte principale de la devinette -->
    {% if devinette.is_dispo or user.is_superuser %}
    <div class="enigme-card">
        <div class="enigme-content">
            <!-- Texte de la devinette -->
            <div class="enigme-text">
                {{ devinette.texte|safe }}
            </div>

            <!-- Image de la devinette si disponible -->
            {% if devinette.image_name %}
            <div class="enigme-image-container">
                <a href="/media/{{ devinette.image_name }}" class="image-lightbox" data-lightbox="devinette-image">
                    <img src="/media/{{ devinette.image_name }}" alt="Image de la devinette" class="enigme-image">
                    <div class="image-zoom-hint">
                        <span>ğŸ” Cliquer pour agrandir</span>
                    </div>
                </a>
            </div>
            {% endif %}

            <!-- Formulaire de rÃ©ponse -->
            <div class="enigme-form">
                <form method="post" action="{% url 'avent2025:validate_devinette' %}">
                    {% csrf_token %}
                    <label for="reponse">ğŸ’­ Votre rÃ©ponse :</label>
                    <div class="enigme-input-group">
                        <input 
                            type="text" 
                            id="reponse" 
                            name="reponse" 
                            class="enigme-input" 
                            placeholder="Entrez votre rÃ©ponse..."
                            autocomplete="off"
                            required
                        >
                        <button type="submit" class="enigme-submit">
                            âœ“ Valider
                        </button>
                    </div>
                </form>
            </div>

            <!-- Section des indices -->
            {% if indices %}
            <div class="indices-section" id="indices">
                <div class="indices-header">
                    <h3>ğŸ’¡ Indices disponibles</h3>
                    <span class="indices-count">{{ indices|length }} indice{{ indices|length|pluralize }}</span>
                </div>

                {% for indice in indices %}
                <div class="indice-card{% if indice.type_indice == 'LC' %} last-chance{% endif %}">
                    <div class="indice-header">
                        <div class="indice-title-section">
                            <span class="indice-number">Indice #{{ indice.numero }}</span>
                            <span class="indice-badges">
                                {% if indice.type_indice == 'LC' %}
                                <span class="indice-last-chance-badge" title="DerniÃ¨re chance - CoÃ»t plus Ã©levÃ©">
                                    âš ï¸ DERNIÃˆRE CHANCE
                                </span>
                                {% endif %}
                                <span class="indice-cost-badge{% if indice.type_indice == 'LC' %} cost-high{% endif %}" title="CoÃ»t en points">
                                    ğŸ’° {{ indice.cout }} pt{{ indice.cout|pluralize }}
                                </span>
                                {% if indice.categorie == 'ME' %}
                                <span class="indice-category-badge category-mecanique" title="MÃ©canique">
                                    ğŸ”§ MÃ©canique
                                </span>
                                {% elif indice.categorie == 'RE' %}
                                <span class="indice-category-badge category-reponse" title="RÃ©ponse attendue">
                                    ğŸ’¡ RÃ©ponse
                                </span>
                                {% endif %}
                            </span>
                        </div>
                        {% if indice not in indices_reveles %}
                        <form method="post" action="{% url 'avent2025:reveler_indice_devinette' %}" style="margin: 0;">
                            {% csrf_token %}
                            <input type="hidden" name="indice_id" value="{{ indice.id }}">
                            <button type="submit" class="indice-reveal-btn">
                                ğŸ”“ RÃ©vÃ©ler (-{{ indice.cout }} pt{{ indice.cout|pluralize }})
                            </button>
                        </form>
                        {% endif %}
                    </div>
                    
                    {% if indice in indices_reveles %}
                    <div class="indice-content">
                        {% if indice.texte %}
                            <p>{{ indice.texte|safe }}</p>
                        {% endif %}
                        {% if indice.image %}
                            <div class="enigme-image-container">
                                <a href="/media/{{ indice.image }}" class="image-lightbox" data-lightbox="indice-image">
                                    <img src="/media/{{ indice.image }}" alt="Image de l'indice" class="indice-image">
                                    <div class="image-zoom-hint">
                                        <span>ğŸ” Cliquer pour agrandir</span>
                                    </div>
                                </a>
                            </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="indice-hidden">
                        ğŸ”’ Cet indice est verrouillÃ©. Cliquez sur "RÃ©vÃ©ler l'indice" pour le dÃ©bloquer.
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
    {% else %}
    <!-- Devinette pas encore disponible -->
    <div class="waiting-card">
        <div class="waiting-icon">ğŸ”’</div>
        <h2>Devinette verrouillÃ©e</h2>
        <p>Cette devinette sera disponible le <strong>{{ devinette.date_dispo|date:"d/m/Y" }}</strong></p>
        <a href="{% url 'avent2025:home' %}" class="enigme-submit">
            ğŸ  Retour Ã  l'accueil
        </a>
    </div>
    {% endif %}

    {% endif %}

    <!-- Boutons de navigation -->
    <div class="enigme-navigation">
        <a href="{% url 'avent2025:home' %}" class="nav-btn">
            â† Retour Ã  l'accueil
        </a>
        {% if user.userprofile_2025.currentDevinette < 25 %}
        <a href="{% url 'avent2025:display_devinette' %}" class="nav-btn">
            Devinette actuelle â†’
        </a>
        {% endif %}
    </div>
</div>

{% endblock %}
