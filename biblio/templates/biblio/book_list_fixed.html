{% extends 'biblio/base.html' %}
{% load biblio_extras %}

{% block title %}Liste des livres{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-list"></i> Liste des livres</h1>
    <a href="{% url 'biblio:add_book_isbn' %}" class="btn btn-primary">
        <i class="bi bi-plus"></i> Ajouter un livre
    </a>
</div>

<!-- Barre de recherche -->
<div class="mb-4">
    <div class="input-group">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input type="text" id="searchInput" class="form-control" placeholder="Rechercher par titre, auteur ou ISBN...">
    </div>
</div>

<!-- Résultats de recherche AJAX (initialement caché) -->
<div id="search-results" class="mb-4" style="display: none;">
    <h5>Résultats de recherche</h5>
    <div id="search-results-content"></div>
    <button id="clear-search" class="btn btn-outline-secondary btn-sm mt-2">Effacer la recherche</button>
</div>

<!-- Filtres collapsables -->
<div class="accordion mb-4" id="filtersAccordion">
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse">
                <i class="bi bi-funnel me-2"></i> Filtres et tri
            </button>
        </h2>
        <div id="filtersCollapse" class="accordion-collapse collapse">
            <div class="accordion-body">
                <form method="GET" class="row g-3">
                    <!-- Tri -->
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Trier par :</label>
                        <div class="d-flex flex-wrap gap-2">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sort" value="title" id="sort_title"
                                       {% if sort == 'title' %}checked{% endif %}>
                                <label class="form-check-label" for="sort_title">Titre A-Z</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sort" value="-title" id="sort_title_desc"
                                       {% if sort == '-title' %}checked{% endif %}>
                                <label class="form-check-label" for="sort_title_desc">Titre Z-A</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sort" value="-added_date" id="sort_date_desc"
                                       {% if sort == '-added_date' or not sort %}checked{% endif %}>
                                <label class="form-check-label" for="sort_date_desc">Plus récent</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sort" value="added_date" id="sort_date_asc"
                                       {% if sort == 'added_date' %}checked{% endif %}>
                                <label class="form-check-label" for="sort_date_asc">Plus ancien</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sort" value="-rating" id="sort_rating"
                                       {% if sort == '-rating' %}checked{% endif %}>
                                <label class="form-check-label" for="sort_rating">Mieux notés</label>
                            </div>
                        </div>
                    </div>

                    <!-- Filtres -->
                    <div class="col-md-6">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label for="author" class="form-label">Auteur :</label>
                                <input type="text" class="form-control" name="author" value="{{ author }}" placeholder="Nom de l'auteur">
                            </div>
                            <div class="col-md-6">
                                <label for="theme" class="form-label">Thème :</label>
                                <input type="text" class="form-control" name="theme" value="{{ theme }}" placeholder="Thème du livre">
                            </div>
                            <div class="col-md-6">
                                <label for="rating" class="form-label">Note minimum :</label>
                                <select class="form-select" name="rating">
                                    <option value="">Toutes les notes</option>
                                    {% for i in "12345" %}
                                        <option value="{{ i }}" {% if rating == i %}selected{% endif %}>{{ i }} étoile{{ i|add:0|pluralize }}+</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="status" class="form-label">Statut :</label>
                                <select class="form-select" name="status">
                                    <option value="">Tous</option>
                                    <option value="read" {% if status == 'read' %}selected{% endif %}>Lu</option>
                                    <option value="unread" {% if status == 'unread' %}selected{% endif %}>Non lu</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-funnel"></i> Appliquer les filtres
                        </button>
                        <a href="{% url 'biblio:book_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Effacer
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Liste des livres -->
{% if books %}
    <div id="books-container">
        <div class="row">
            {% for book in books %}
                <div class="col-md-3 col-sm-6 mb-4 book-item" data-book-id="{{ book.pk }}">
                    <div class="card h-100 book-card">
                        <!-- Image de couverture avec overlay -->
                        <div class="position-relative">
                            {% if book.cover_image_url %}
                                <img src="{{ book.cover_image_url }}" class="card-img-top book-cover" alt="{{ book.title }}">
                            {% else %}
                                <div class="card-img-top bg-light d-flex align-items-center justify-content-center book-cover">
                                    <i class="bi bi-book display-4 text-muted"></i>
                                </div>
                            {% endif %}
                            
                            <!-- Overlay avec actions -->
                            <div class="book-overlay">
                                <div class="overlay-actions">
                                    <a href="{% url 'biblio:book_detail' book.pk %}" class="btn btn-light btn-sm">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{% url 'biblio:edit_book' book.pk %}" class="btn btn-warning btn-sm">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="card-body d-flex flex-column">
                            <h6 class="card-title mb-2">
                                <a href="{% url 'biblio:book_detail' book.pk %}" class="text-decoration-none">
                                    {{ book.title|truncatechars:30 }}
                                </a>
                            </h6>
                            
                            {% if book.authors %}
                                <p class="card-text text-muted small mb-1">
                                    <i class="bi bi-person"></i> {{ book.authors|truncatechars:25 }}
                                </p>
                            {% endif %}

                            {% if book.rating %}
                                <div class="mb-2">
                                    {% for i in book.rating|star_range %}
                                        <i class="bi bi-star-fill text-warning small"></i>
                                    {% endfor %}
                                    {% for i in book.rating|empty_star_range %}
                                        <i class="bi bi-star text-muted small"></i>
                                    {% endfor %}
                                </div>
                            {% endif %}

                            {% if book.themes %}
                                <div class="mb-2">
                                    {% for theme in book.themes|split:","|slice:":2" %}
                                        <span class="badge bg-secondary badge-sm">{{ theme|trim|truncatechars:15 }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}

                            <div class="mt-auto">
                                <small class="text-muted">Ajouté {{ book.added_date|timesince }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Pagination améliorée -->
    {% if books.has_other_pages %}
        <nav aria-label="Navigation des pages" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if books.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.author %}&author={{ request.GET.author }}{% endif %}{% if request.GET.theme %}&theme={{ request.GET.theme }}{% endif %}{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                            <i class="bi bi-chevron-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ books.previous_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.author %}&author={{ request.GET.author }}{% endif %}{% if request.GET.theme %}&theme={{ request.GET.theme }}{% endif %}{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                {% endif %}

                {% for num in books.paginator.page_range %}
                    {% if num == books.number %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > books.number|add:'-3' and num < books.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.author %}&author={{ request.GET.author }}{% endif %}{% if request.GET.theme %}&theme={{ request.GET.theme }}{% endif %}{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if books.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ books.next_page_number }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.author %}&author={{ request.GET.author }}{% endif %}{% if request.GET.theme %}&theme={{ request.GET.theme }}{% endif %}{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ books.paginator.num_pages }}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.author %}&author={{ request.GET.author }}{% endif %}{% if request.GET.theme %}&theme={{ request.GET.theme }}{% endif %}{% if request.GET.rating %}&rating={{ request.GET.rating }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">
                            <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
            
            <div class="text-center text-muted">
                Page {{ books.number }} sur {{ books.paginator.num_pages }} 
                ({{ books.paginator.count }} livres au total)
            </div>
        </nav>
    {% endif %}
{% else %}
    <div class="text-center py-5">
        <i class="bi bi-book display-1 text-muted"></i>
        <h3 class="mt-3">Aucun livre trouvé</h3>
        <p class="text-muted">Commencez par ajouter votre premier livre à la bibliothèque.</p>
        <a href="{% url 'biblio:add_book_isbn' %}" class="btn btn-primary">
            <i class="bi bi-plus"></i> Ajouter un livre
        </a>
    </div>
{% endif %}

<script>
// Recherche AJAX en temps réel
document.getElementById('searchInput').addEventListener('input', function() {
    const query = this.value.trim();
    const searchResults = document.getElementById('search-results');
    const searchResultsContent = document.getElementById('search-results-content');
    const booksContainer = document.getElementById('books-container');
    
    if (query.length < 2) {
        searchResults.style.display = 'none';
        if (booksContainer) booksContainer.style.display = 'block';
        return;
    }
    
    fetch(`{% url 'biblio:ajax_search' %}?q=${encodeURIComponent(query)}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.books && data.books.length > 0) {
            let html = '<div class="row">';
            data.books.forEach(book => {
                html += `
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <a href="/biblio/livre/${book.id}/" class="text-decoration-none">${book.title}</a>
                                </h6>
                                ${book.authors ? `<p class="card-text text-muted small"><i class="bi bi-person"></i> ${book.authors}</p>` : ''}
                                ${book.rating ? generateStars(book.rating) : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            searchResultsContent.innerHTML = html;
            searchResults.style.display = 'block';
            if (booksContainer) booksContainer.style.display = 'none';
        } else {
            searchResultsContent.innerHTML = '<p class="text-muted">Aucun livre trouvé pour cette recherche.</p>';
            searchResults.style.display = 'block';
            if (booksContainer) booksContainer.style.display = 'none';
        }
    })
    .catch(error => {
        console.error('Erreur lors de la recherche:', error);
    });
});

// Effacer la recherche
document.getElementById('clear-search').addEventListener('click', function() {
    document.getElementById('searchInput').value = '';
    document.getElementById('search-results').style.display = 'none';
    const booksContainer = document.getElementById('books-container');
    if (booksContainer) booksContainer.style.display = 'block';
});

// Fonction pour générer les étoiles
function generateStars(rating) {
    let stars = '<div class="mb-2">';
    for (let i = 1; i <= 5; i++) {
        if (i <= rating) {
            stars += '<i class="bi bi-star-fill text-warning small"></i>';
        } else {
            stars += '<i class="bi bi-star text-muted small"></i>';
        }
    }
    stars += '</div>';
    return stars;
}

// Auto-submit du formulaire de tri lors du changement de radio button
document.querySelectorAll('input[name="sort"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
        this.closest('form').submit();
    });
});
</script>

<style>
/* Styles pour les cartes de livres */
.book-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.book-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.book-cover {
    height: 200px;
    object-fit: cover;
}

.book-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.book-card:hover .book-overlay {
    opacity: 1;
}

.overlay-actions {
    display: flex;
    gap: 10px;
}

.badge-sm {
    font-size: 0.7em;
}
</style>
{% endblock %}
