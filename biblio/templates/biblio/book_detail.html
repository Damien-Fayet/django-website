{% extends 'biblio/base.html' %}
{% load biblio_extras %}

{% block title %}{{ book.title }}{% endblock %}

{% block content %}
<!-- Navigation rapide entre livres -->
<div class="row mb-3">
    <div class="col-md-12">
        <nav aria-label="Navigation entre livres">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    {% if previous_book %}
                        <a href="{% url 'biblio:book_detail' previous_book.pk %}" class="btn btn-outline-primary">
                            <i class="bi bi-chevron-left"></i> {{ previous_book.title|truncatechars:20 }}
                        </a>
                    {% else %}
                        <span class="btn btn-outline-secondary disabled">
                            <i class="bi bi-chevron-left"></i> Premier livre
                        </span>
                    {% endif %}
                </div>
                
                <div class="text-center">
                    <span class="badge bg-secondary">Livre {{ current_position }} sur {{ total_books }}</span>
                </div>
                
                <div>
                    {% if next_book %}
                        <a href="{% url 'biblio:book_detail' next_book.pk %}" class="btn btn-outline-primary">
                            {{ next_book.title|truncatechars:20 }} <i class="bi bi-chevron-right"></i>
                        </a>
                    {% else %}
                        <span class="btn btn-outline-secondary disabled">
                            Dernier livre <i class="bi bi-chevron-right"></i>
                        </span>
                    {% endif %}
                </div>
            </div>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        {% if book.cover_image_url %}
            <img src="{{ book.cover_image_url }}" class="img-fluid book-cover rounded shadow" alt="{{ book.title }}">
        {% else %}
            <div class="bg-light d-flex align-items-center justify-content-center rounded shadow" style="height: 300px; width: 100%;">
                <i class="bi bi-book display-3 text-muted"></i>
            </div>
        {% endif %}
        
        <div class="mt-3 d-grid gap-2">
            <a href="{% url 'biblio:edit_book' book.pk %}" class="btn btn-primary" title="Raccourci: E">
                <i class="bi bi-pencil"></i> Modifier <kbd>E</kbd>
            </a>
            <a href="{% url 'biblio:delete_book' book.pk %}" class="btn btn-outline-danger" title="Raccourci: Suppr">
                <i class="bi bi-trash"></i> Supprimer
            </a>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <h1>{{ book.title }}</h1>
            <!-- Breadcrumb amélioré -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'biblio:index' %}">Accueil</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'biblio:book_list' %}">Livres</a></li>
                    <li class="breadcrumb-item active">{{ book.title|truncatechars:30 }}</li>
                </ol>
            </nav>
        </div>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <h6><i class="bi bi-person"></i> Auteur(s)</h6>
                <p>{{ book.authors }}</p>
                
                {% if book.publisher %}
                    <h6><i class="bi bi-building"></i> Éditeur</h6>
                    <p>{{ book.publisher }}</p>
                {% endif %}
                
                {% if book.published_date %}
                    <h6><i class="bi bi-calendar"></i> Date de publication</h6>
                    <p>{{ book.published_date|date:"d F Y" }}</p>
                {% endif %}
                
                {% if book.page_count %}
                    <h6><i class="bi bi-file-text"></i> Nombre de pages</h6>
                    <p>{{ book.page_count }}</p>
                {% endif %}
            </div>
            
            <div class="col-md-6">
                <h6><i class="bi bi-upc-scan"></i> ISBN</h6>
                <p><code>{{ book.isbn }}</code></p>
                
                {% if book.age_range %}
                    <h6><i class="bi bi-people"></i> Tranche d'âge</h6>
                    <p><span class="badge bg-info">{{ book.age_range }}</span></p>
                {% endif %}
                
                {% if book.reading_level %}
                    <h6><i class="bi bi-mortarboard"></i> Niveau de lecture</h6>
                    <p><span class="badge bg-secondary">{{ book.reading_level }}</span></p>
                {% endif %}
                
                {% if book.themes %}
                    <h6><i class="bi bi-tags"></i> Thème(s)</h6>
                    <p>
                        {% for theme in book.themes|split:"," %}
                            <span class="badge bg-primary me-1">{{ theme|trim }}</span>
                        {% endfor %}
                    </p>
                {% endif %}
                
                {% if book.rating %}
                    <h6><i class="bi bi-star"></i> Note</h6>
                    <div class="rating">
                        {% for i in "12345" %}
                            {% if forloop.counter <= book.rating %}
                                <i class="bi bi-star-fill"></i>
                            {% else %}
                                <i class="bi bi-star"></i>
                            {% endif %}
                        {% endfor %}
                        <span class="ms-2">{{ book.rating }}/5</span>
                    </div>
                {% endif %}
            </div>
        </div>
        
        {% if book.description %}
            <div class="mb-4">
                <h6><i class="bi bi-journal-text"></i> Description</h6>
                <div class="border-start border-primary ps-3">
                    <p>{{ book.description|linebreaks }}</p>
                </div>
            </div>
        {% endif %}
        
        {% if book.comments %}
            <div class="mb-4">
                <h6><i class="bi bi-chat-left-text"></i> Commentaires</h6>
                <div class="alert alert-light">
                    <p class="mb-0">{{ book.comments|linebreaks }}</p>
                </div>
            </div>
        {% endif %}
        
        <div class="row text-muted small">
            <div class="col-md-6">
                <i class="bi bi-plus-circle"></i> Ajouté le {{ book.added_date|date:"d/m/Y à H:i" }}
            </div>
            <div class="col-md-6">
                <i class="bi bi-pencil-square"></i> Modifié le {{ book.updated_date|date:"d/m/Y à H:i" }}
            </div>
        </div>
    </div>
</div>

<!-- Navigation de retour sticky -->
<div class="sticky-bottom bg-white border-top py-2 mt-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <a href="{% url 'biblio:book_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Retour à la liste
            </a>
            
            <div class="btn-group">
                <a href="{% url 'biblio:edit_book' book.pk %}" class="btn btn-primary">
                    <i class="bi bi-pencil"></i> Modifier
                </a>
                <button class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="bi bi-three-dots"></i>
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="window.print()">
                        <i class="bi bi-printer"></i> Imprimer
                    </a></li>
                    <li><a class="dropdown-item copy-url" href="#">
                        <i class="bi bi-link"></i> Copier le lien
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="{% url 'biblio:delete_book' book.pk %}">
                        <i class="bi bi-trash"></i> Supprimer
                    </a></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Raccourcis clavier
    document.addEventListener('keydown', function(e) {
        if (e.target.tagName.toLowerCase() === 'input' || e.target.tagName.toLowerCase() === 'textarea') return;
        
        switch(e.key.toLowerCase()) {
            case 'e':
                if (!e.ctrlKey && !e.metaKey) {
                    window.location.href = "{% url 'biblio:edit_book' book.pk %}";
                }
                break;
            case 'arrowleft':
                {% if previous_book %}
                    window.location.href = "{% url 'biblio:book_detail' previous_book.pk %}";
                {% endif %}
                break;
            case 'arrowright':
                {% if next_book %}
                    window.location.href = "{% url 'biblio:book_detail' next_book.pk %}";
                {% endif %}
                break;
            case 'escape':
                window.location.href = "{% url 'biblio:book_list' %}";
                break;
        }
    });
    
    // Copier URL
    document.querySelectorAll('.copy-url').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            navigator.clipboard.writeText(window.location.href).then(function() {
                alert('Lien copié dans le presse-papiers !');
            });
        });
    });
});
</script>

<style>
.sticky-bottom {
    position: sticky;
    bottom: 0;
    z-index: 1020;
    box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
}

@media print {
    .sticky-bottom, nav[aria-label="Navigation entre livres"] {
        display: none !important;
    }
}
</style>
{% endblock %}
